import { DeclarationStatement, Source, ClassDeclaration, TypeNode, InterfaceDeclaration, FunctionDeclaration, TypeName, NamedTypeNode, util, } from "assemblyscript/dist/assemblyscript.js";
import { ASTBuilder } from "./astBuilder.js";
import cloneDeep from "lodash.clonedeep";
// const cloneDeep: <T>(t: T) => T = require("lodash.clonedeep") as any;
export function decorates(node, name) {
    return node.name.text === name;
}
export function isDecorator(name) {
    return (node) => decorates(node, name);
}
export function hasDecorator(node, name) {
    let decl;
    if (node instanceof DeclarationStatement) {
        decl = node;
    }
    else {
        decl = node.declaration;
    }
    // because it could be undefined
    return decl.decorators?.some(isDecorator(name)) == true;
}
export function getDecorator(node, name) {
    return node.decorators?.find(isDecorator(name));
}
export function isLibrary(node) {
    return node.isLibrary || node.internalPath.startsWith("~lib/rt/");
}
export function not(fn) {
    return (t) => !fn(t);
}
export function toString(node) {
    return ASTBuilder.build(node);
}
const OR_NULL = /\|.*null/;
export function getName(node) {
    if (node instanceof TypeNode) {
        if (node instanceof NamedTypeNode) {
            let name = getTypeName(node.name);
            const typeParameters = node.typeArguments;
            if (typeParameters && typeParameters.length > 0) {
                name += `<${typeParameters.map(getName).join(", ")}>`;
            }
            if (node.isNullable && !OR_NULL.test(name)) {
                name = `${name} | null`;
            }
            return name;
        }
        else if (node instanceof TypeName) {
            return toString(node.identifier);
        }
        return "";
    }
    if (node instanceof ClassDeclaration || node instanceof InterfaceDeclaration || node instanceof FunctionDeclaration) {
        return className(node);
    }
    return toString(node.name);
}
export function getTypeName(node) {
    const partNames = [];
    let currentNode = node;
    while (currentNode) {
        partNames.push(toString(currentNode.identifier));
        currentNode = currentNode.next;
    }
    return partNames.join(".");
}
export function cloneNode(node) {
    return cloneDeep(node);
}
export function isUserEntry(node) {
    return node.range.source.sourceKind == 1 /* SourceKind.UserEntry */;
}
export function isEntry(node) {
    return isUserEntry(node) || node.range.source.sourceKind == 3 /* SourceKind.LibraryEntry */;
}
export function className(_class) {
    let name = toString(_class.name);
    const typeParameters = _class.typeParameters;
    if (typeParameters) {
        name += `<${typeParameters.map(getName).join(", ")}>`;
    }
    return name;
}
export function isMethodNamed(name) {
    return (stmt) => stmt.kind == 58 /* NodeKind.MethodDeclaration */ && toString(stmt.name) === name;
}
export function updateSource(program, newSource) {
    const sources = program.sources;
    for (let i = 0, len = sources.length; i < len; i++) {
        if (sources[i].internalPath == newSource.internalPath) {
            sources[i] = newSource;
            break;
        }
    }
}
export class StringBuilder {
    sb = [];
    push(s) {
        this.sb.push(s);
    }
    finish(separator = "\n") {
        let res = this.sb.join(separator);
        this.sb = [];
        return res;
    }
    get last() { return this.sb[this.sb.length - 1]; }
}
/**
 *
 * @param emitter DiagnosticEmitter
 * @returns return true if emitter have ERROR message
 */
export function hasErrorMessage(emitter) {
    return hasMessage(emitter, 3 /* DiagnosticCategory.Error */);
}
/**
*
* @param emitter DiagnosticEmitter
* @returns return true if emitter have WARNING message
*/
export function hasWarningMessage(emitter) {
    return hasMessage(emitter, 2 /* DiagnosticCategory.Warning */);
}
/**
*
* @param emitter DiagnosticEmitter
* @returns return true if emitter have `category` message
*/
export function hasMessage(emitter, category) {
    const diagnostics = emitter.diagnostics ? emitter.diagnostics : [];
    for (const msg of diagnostics) {
        if (msg.category === category) {
            return true;
        }
    }
    return false;
}
let isStdlibRegex = /\~lib\/(?:array|arraybuffer|atomics|builtins|crypto|console|compat|dataview|date|diagnostics|error|function|iterator|map|math|number|object|process|reference|regexp|set|staticarray|string|symbol|table|typedarray|vector|rt\/?|bindings\/|shared\/typeinfo)|util\/|uri|polyfills|memory/;
export function isStdlib(s) {
    let source = s instanceof Source ? s : s.range.source;
    return isStdlibRegex.test(source.internalPath);
}
export const indent = util.indent;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvdXRpbHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUdMLG9CQUFvQixFQUNwQixNQUFNLEVBSU4sZ0JBQWdCLEVBQ2hCLFFBQVEsRUFFUixvQkFBb0IsRUFDcEIsbUJBQW1CLEVBQ25CLFFBQVEsRUFHUixhQUFhLEVBRWIsSUFBSSxHQUNMLE1BQU0sdUNBQXVDLENBQUM7QUFDL0MsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzdDLE9BQU8sU0FBUyxNQUFNLGtCQUFrQixDQUFDO0FBRXpDLHdFQUF3RTtBQUV4RSxNQUFNLFVBQVUsU0FBUyxDQUFDLElBQW1CLEVBQUUsSUFBWTtJQUN6RCxPQUE4QixJQUFJLENBQUMsSUFBSyxDQUFDLElBQUksS0FBSyxJQUFJLENBQUM7QUFDekQsQ0FBQztBQUVELE1BQU0sVUFBVSxXQUFXLENBQUMsSUFBWTtJQUN0QyxPQUFPLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO0FBQ3pDLENBQUM7QUFHRCxNQUFNLFVBQVUsWUFBWSxDQUMxQixJQUFnRSxFQUNoRSxJQUFZO0lBRVosSUFBSSxJQUFJLENBQUM7SUFDVCxJQUFJLElBQUksWUFBWSxvQkFBb0IsRUFBRSxDQUFDO1FBQ3pDLElBQUksR0FBRyxJQUFJLENBQUM7SUFDZCxDQUFDO1NBQU0sQ0FBQztRQUNOLElBQUksR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDO0lBQzFCLENBQUM7SUFDRCxnQ0FBZ0M7SUFDaEMsT0FBTyxJQUFJLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxJQUFJLENBQUM7QUFDMUQsQ0FBQztBQUVELE1BQU0sVUFBVSxZQUFZLENBQzFCLElBQTBCLEVBQzFCLElBQVk7SUFFWixPQUFPLElBQUksQ0FBQyxVQUFVLEVBQUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBRSxDQUFDO0FBQ25ELENBQUM7QUFFRCxNQUFNLFVBQVUsU0FBUyxDQUFDLElBQVk7SUFDcEMsT0FBTyxJQUFJLENBQUMsU0FBUyxJQUFJLElBQUksQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0FBQ3BFLENBQUM7QUFFRCxNQUFNLFVBQVUsR0FBRyxDQUFJLEVBQXFCO0lBQzFDLE9BQU8sQ0FBQyxDQUFJLEVBQUUsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQzFCLENBQUM7QUFFRCxNQUFNLFVBQVUsUUFBUSxDQUFDLElBQVU7SUFDakMsT0FBTyxVQUFVLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQ2hDLENBQUM7QUFNRCxNQUFNLE9BQU8sR0FBRyxVQUFVLENBQUM7QUFHM0IsTUFBTSxVQUFVLE9BQU8sQ0FBQyxJQUE2QjtJQUNuRCxJQUFJLElBQUksWUFBWSxRQUFRLEVBQUUsQ0FBQztRQUM3QixJQUFJLElBQUksWUFBWSxhQUFhLEVBQUUsQ0FBQztZQUNsQyxJQUFJLElBQUksR0FBRyxXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFBO1lBQ2pDLE1BQU0sY0FBYyxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUM7WUFDMUMsSUFBSSxjQUFjLElBQUksY0FBYyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUUsQ0FBQztnQkFDaEQsSUFBSSxJQUFJLElBQUksY0FBYyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQztZQUN4RCxDQUFDO1lBQ0QsSUFBSSxJQUFJLENBQUMsVUFBVSxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO2dCQUMzQyxJQUFJLEdBQUcsR0FBRyxJQUFJLFNBQVMsQ0FBQztZQUMxQixDQUFDO1lBQ0QsT0FBTyxJQUFJLENBQUE7UUFDYixDQUFDO2FBQU0sSUFBSSxJQUFJLFlBQVksUUFBUSxFQUFFLENBQUM7WUFDcEMsT0FBTyxRQUFRLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFBO1FBQ2xDLENBQUM7UUFDRCxPQUFPLEVBQUUsQ0FBQztJQUNaLENBQUM7SUFDRCxJQUFJLElBQUksWUFBWSxnQkFBZ0IsSUFBSSxJQUFJLFlBQVksb0JBQW9CLElBQUksSUFBSSxZQUFZLG1CQUFtQixFQUFFLENBQUM7UUFDcEgsT0FBTyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDekIsQ0FBQztJQUNELE9BQU8sUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUM3QixDQUFDO0FBR0QsTUFBTSxVQUFVLFdBQVcsQ0FBQyxJQUFjO0lBQ3hDLE1BQU0sU0FBUyxHQUFHLEVBQUUsQ0FBQztJQUNyQixJQUFJLFdBQVcsR0FBb0IsSUFBSSxDQUFDO0lBQ3hDLE9BQU8sV0FBVyxFQUFFLENBQUM7UUFDbkIsU0FBUyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUM7UUFDakQsV0FBVyxHQUFHLFdBQVcsQ0FBQyxJQUFJLENBQUM7SUFDakMsQ0FBQztJQUNELE9BQU8sU0FBUyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUM3QixDQUFDO0FBRUQsTUFBTSxVQUFVLFNBQVMsQ0FBaUIsSUFBTztJQUMvQyxPQUFPLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUN6QixDQUFDO0FBRUQsTUFBTSxVQUFVLFdBQVcsQ0FBQyxJQUFVO0lBQ3BDLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsVUFBVSxnQ0FBd0IsQ0FBQztBQUM5RCxDQUFDO0FBRUQsTUFBTSxVQUFVLE9BQU8sQ0FBQyxJQUFVO0lBQ2hDLE9BQU8sV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLFVBQVUsbUNBQTJCLENBQUM7QUFDdEYsQ0FBQztBQUVELE1BQU0sVUFBVSxTQUFTLENBQUMsTUFBc0U7SUFDOUYsSUFBSSxJQUFJLEdBQUcsUUFBUSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQTtJQUNoQyxNQUFNLGNBQWMsR0FBRyxNQUFNLENBQUMsY0FBYyxDQUFDO0lBQzdDLElBQUksY0FBYyxFQUFFLENBQUM7UUFDbkIsSUFBSSxJQUFJLElBQUksY0FBYyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQztJQUN4RCxDQUFDO0lBQ0QsT0FBTyxJQUFJLENBQUM7QUFDZCxDQUFDO0FBRUQsTUFBTSxVQUFVLGFBQWEsQ0FBQyxJQUFZO0lBQ3hDLE9BQU8sQ0FBQyxJQUEwQixFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSx1Q0FBOEIsSUFBSSxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLElBQUksQ0FBQztBQUNqSCxDQUFDO0FBRUQsTUFBTSxVQUFVLFlBQVksQ0FBQyxPQUFnQixFQUFFLFNBQWlCO0lBQzlELE1BQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUM7SUFDaEMsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsR0FBRyxHQUFHLE9BQU8sQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLEdBQUcsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO1FBQ2pELElBQUksT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLFlBQVksSUFBSSxTQUFTLENBQUMsWUFBWSxFQUFFLENBQUM7WUFDcEQsT0FBTyxDQUFDLENBQUMsQ0FBQyxHQUFHLFNBQVMsQ0FBQztZQUN2QixNQUFNO1FBQ1YsQ0FBQztJQUNMLENBQUM7QUFDSCxDQUFDO0FBRUQsTUFBTSxPQUFPLGFBQWE7SUFDaEIsRUFBRSxHQUFhLEVBQUUsQ0FBQztJQUUxQixJQUFJLENBQUMsQ0FBUztRQUNaLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2xCLENBQUM7SUFFRCxNQUFNLENBQUMsU0FBUyxHQUFHLElBQUk7UUFDckIsSUFBSSxHQUFHLEdBQUcsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDbEMsSUFBSSxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUM7UUFDYixPQUFPLEdBQUcsQ0FBQztJQUNiLENBQUM7SUFFRCxJQUFLLElBQUksS0FBYSxPQUFPLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxNQUFNLEdBQUUsQ0FBQyxDQUFDLENBQUEsQ0FBQSxDQUFDO0NBQ3pEO0FBRUQ7Ozs7R0FJRztBQUNGLE1BQU0sVUFBVSxlQUFlLENBQUMsT0FBMEI7SUFDekQsT0FBTyxVQUFVLENBQUMsT0FBTyxtQ0FBMkIsQ0FBQztBQUN2RCxDQUFDO0FBRUQ7Ozs7RUFJRTtBQUNGLE1BQU0sVUFBVSxpQkFBaUIsQ0FBQyxPQUEwQjtJQUMxRCxPQUFPLFVBQVUsQ0FBQyxPQUFPLHFDQUE2QixDQUFDO0FBQ3pELENBQUM7QUFFRDs7OztFQUlFO0FBQ0YsTUFBTSxVQUFVLFVBQVUsQ0FDeEIsT0FBMEIsRUFDMUIsUUFBNEI7SUFFNUIsTUFBTSxXQUFXLEdBQUcsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO0lBQ25FLEtBQUssTUFBTSxHQUFHLElBQUksV0FBVyxFQUFFLENBQUM7UUFDNUIsSUFBSSxHQUFHLENBQUMsUUFBUSxLQUFLLFFBQVEsRUFBRSxDQUFDO1lBQzVCLE9BQU8sSUFBSSxDQUFDO1FBQ2hCLENBQUM7SUFDTCxDQUFDO0lBQ0QsT0FBTyxLQUFLLENBQUM7QUFDZixDQUFDO0FBR0QsSUFBSSxhQUFhLEdBQ2YsMlJBQTJSLENBQUM7QUFFOVIsTUFBTSxVQUFVLFFBQVEsQ0FBQyxDQUE0QjtJQUNuRCxJQUFJLE1BQU0sR0FBRyxDQUFDLFlBQVksTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDO0lBQ3RELE9BQU8sYUFBYSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLENBQUM7QUFDakQsQ0FBQztBQUVELE1BQU0sQ0FBQyxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcclxuICBEZWNvcmF0b3JOb2RlLFxyXG4gIElkZW50aWZpZXJFeHByZXNzaW9uLFxyXG4gIERlY2xhcmF0aW9uU3RhdGVtZW50LFxyXG4gIFNvdXJjZSxcclxuICBOb2RlLFxyXG4gIFNvdXJjZUtpbmQsXHJcbiAgUHJvZ3JhbSxcclxuICBDbGFzc0RlY2xhcmF0aW9uLFxyXG4gIFR5cGVOb2RlLFxyXG4gIE5vZGVLaW5kLFxyXG4gIEludGVyZmFjZURlY2xhcmF0aW9uLFxyXG4gIEZ1bmN0aW9uRGVjbGFyYXRpb24sXHJcbiAgVHlwZU5hbWUsXHJcbiAgRGlhZ25vc3RpY0NhdGVnb3J5LFxyXG4gIERpYWdub3N0aWNFbWl0dGVyLFxyXG4gIE5hbWVkVHlwZU5vZGUsXHJcbiAgUmFuZ2UsXHJcbiAgdXRpbCxcclxufSBmcm9tIFwiYXNzZW1ibHlzY3JpcHQvZGlzdC9hc3NlbWJseXNjcmlwdC5qc1wiO1xyXG5pbXBvcnQgeyBBU1RCdWlsZGVyIH0gZnJvbSBcIi4vYXN0QnVpbGRlci5qc1wiO1xyXG5pbXBvcnQgY2xvbmVEZWVwIGZyb20gXCJsb2Rhc2guY2xvbmVkZWVwXCI7XHJcblxyXG4vLyBjb25zdCBjbG9uZURlZXA6IDxUPih0OiBUKSA9PiBUID0gcmVxdWlyZShcImxvZGFzaC5jbG9uZWRlZXBcIikgYXMgYW55O1xyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGRlY29yYXRlcyhub2RlOiBEZWNvcmF0b3JOb2RlLCBuYW1lOiBzdHJpbmcpOiBib29sZWFuIHtcclxuICByZXR1cm4gKDxJZGVudGlmaWVyRXhwcmVzc2lvbj5ub2RlLm5hbWUpLnRleHQgPT09IG5hbWU7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBpc0RlY29yYXRvcihuYW1lOiBzdHJpbmcpOiAobm9kZTogRGVjb3JhdG9yTm9kZSkgPT4gYm9vbGVhbiB7XHJcbiAgcmV0dXJuIChub2RlKSA9PiBkZWNvcmF0ZXMobm9kZSwgbmFtZSk7XHJcbn1cclxuXHJcblxyXG5leHBvcnQgZnVuY3Rpb24gaGFzRGVjb3JhdG9yKFxyXG4gIG5vZGU6IERlY2xhcmF0aW9uU3RhdGVtZW50IHwge2RlY2xhcmF0aW9uOiBEZWNsYXJhdGlvblN0YXRlbWVudH0sXHJcbiAgbmFtZTogc3RyaW5nXHJcbik6IGJvb2xlYW4ge1xyXG4gIGxldCBkZWNsO1xyXG4gIGlmIChub2RlIGluc3RhbmNlb2YgRGVjbGFyYXRpb25TdGF0ZW1lbnQpIHtcclxuICAgIGRlY2wgPSBub2RlO1xyXG4gIH0gZWxzZSB7XHJcbiAgICBkZWNsID0gbm9kZS5kZWNsYXJhdGlvbjsgXHJcbiAgfSBcclxuICAvLyBiZWNhdXNlIGl0IGNvdWxkIGJlIHVuZGVmaW5lZFxyXG4gIHJldHVybiBkZWNsLmRlY29yYXRvcnM/LnNvbWUoaXNEZWNvcmF0b3IobmFtZSkpID09IHRydWU7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXREZWNvcmF0b3IoXHJcbiAgbm9kZTogRGVjbGFyYXRpb25TdGF0ZW1lbnQsXHJcbiAgbmFtZTogc3RyaW5nXHJcbik6IERlY29yYXRvck5vZGUge1xyXG4gIHJldHVybiBub2RlLmRlY29yYXRvcnM/LmZpbmQoaXNEZWNvcmF0b3IobmFtZSkpITtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGlzTGlicmFyeShub2RlOiBTb3VyY2UpOiBib29sZWFuIHtcclxuICByZXR1cm4gbm9kZS5pc0xpYnJhcnkgfHwgbm9kZS5pbnRlcm5hbFBhdGguc3RhcnRzV2l0aChcIn5saWIvcnQvXCIpO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gbm90PFQ+KGZuOiAodDogVCkgPT4gYm9vbGVhbik6ICh0OiBUKSA9PiBib29sZWFuIHtcclxuICByZXR1cm4gKHQ6IFQpID0+ICFmbih0KTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHRvU3RyaW5nKG5vZGU6IE5vZGUpOiBzdHJpbmcge1xyXG4gIHJldHVybiBBU1RCdWlsZGVyLmJ1aWxkKG5vZGUpO1xyXG59XHJcblxyXG5pbnRlcmZhY2UgTmFtZWQge1xyXG4gIG5hbWU6IElkZW50aWZpZXJFeHByZXNzaW9uO1xyXG59XHJcblxyXG5jb25zdCBPUl9OVUxMID0gL1xcfC4qbnVsbC87XHJcblxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGdldE5hbWUobm9kZTogTm9kZSAmIE5hbWVkIHwgVHlwZU5vZGUpOiBzdHJpbmcge1xyXG4gIGlmIChub2RlIGluc3RhbmNlb2YgVHlwZU5vZGUpIHtcclxuICAgIGlmIChub2RlIGluc3RhbmNlb2YgTmFtZWRUeXBlTm9kZSkge1xyXG4gICAgICBsZXQgbmFtZSA9IGdldFR5cGVOYW1lKG5vZGUubmFtZSlcclxuICAgICAgY29uc3QgdHlwZVBhcmFtZXRlcnMgPSBub2RlLnR5cGVBcmd1bWVudHM7XHJcbiAgICAgIGlmICh0eXBlUGFyYW1ldGVycyAmJiB0eXBlUGFyYW1ldGVycy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgbmFtZSArPSBgPCR7dHlwZVBhcmFtZXRlcnMubWFwKGdldE5hbWUpLmpvaW4oXCIsIFwiKX0+YDtcclxuICAgICAgfVxyXG4gICAgICBpZiAobm9kZS5pc051bGxhYmxlICYmICFPUl9OVUxMLnRlc3QobmFtZSkpIHtcclxuICAgICAgICBuYW1lID0gYCR7bmFtZX0gfCBudWxsYDtcclxuICAgICAgfVxyXG4gICAgICByZXR1cm4gbmFtZVxyXG4gICAgfSBlbHNlIGlmIChub2RlIGluc3RhbmNlb2YgVHlwZU5hbWUpIHtcclxuICAgICAgcmV0dXJuIHRvU3RyaW5nKG5vZGUuaWRlbnRpZmllcilcclxuICAgIH1cclxuICAgIHJldHVybiBcIlwiO1xyXG4gIH1cclxuICBpZiAobm9kZSBpbnN0YW5jZW9mIENsYXNzRGVjbGFyYXRpb24gfHwgbm9kZSBpbnN0YW5jZW9mIEludGVyZmFjZURlY2xhcmF0aW9uIHx8IG5vZGUgaW5zdGFuY2VvZiBGdW5jdGlvbkRlY2xhcmF0aW9uKSB7XHJcbiAgICByZXR1cm4gY2xhc3NOYW1lKG5vZGUpO1xyXG4gIH1cclxuICByZXR1cm4gdG9TdHJpbmcobm9kZS5uYW1lKTtcclxufVxyXG5cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRUeXBlTmFtZShub2RlOiBUeXBlTmFtZSk6IHN0cmluZyB7XHJcbiAgY29uc3QgcGFydE5hbWVzID0gW107XHJcbiAgbGV0IGN1cnJlbnROb2RlOiBUeXBlTmFtZSB8IG51bGwgPSBub2RlO1xyXG4gIHdoaWxlIChjdXJyZW50Tm9kZSkge1xyXG4gICAgcGFydE5hbWVzLnB1c2godG9TdHJpbmcoY3VycmVudE5vZGUuaWRlbnRpZmllcikpO1xyXG4gICAgY3VycmVudE5vZGUgPSBjdXJyZW50Tm9kZS5uZXh0O1xyXG4gIH1cclxuICByZXR1cm4gcGFydE5hbWVzLmpvaW4oXCIuXCIpO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gY2xvbmVOb2RlPFQgZXh0ZW5kcyBOb2RlPihub2RlOiBUKTogVCB7XHJcbiAgcmV0dXJuIGNsb25lRGVlcChub2RlKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGlzVXNlckVudHJ5KG5vZGU6IE5vZGUpOiBib29sZWFuIHtcclxuICByZXR1cm4gbm9kZS5yYW5nZS5zb3VyY2Uuc291cmNlS2luZCA9PSBTb3VyY2VLaW5kLlVzZXJFbnRyeTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGlzRW50cnkobm9kZTogTm9kZSk6IGJvb2xlYW4ge1xyXG4gIHJldHVybiBpc1VzZXJFbnRyeShub2RlKSB8fCBub2RlLnJhbmdlLnNvdXJjZS5zb3VyY2VLaW5kID09IFNvdXJjZUtpbmQuTGlicmFyeUVudHJ5O1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gY2xhc3NOYW1lKF9jbGFzczogQ2xhc3NEZWNsYXJhdGlvbiB8ICBJbnRlcmZhY2VEZWNsYXJhdGlvbiB8IEZ1bmN0aW9uRGVjbGFyYXRpb24pOiBzdHJpbmcge1xyXG4gIGxldCBuYW1lID0gdG9TdHJpbmcoX2NsYXNzLm5hbWUpXHJcbiAgY29uc3QgdHlwZVBhcmFtZXRlcnMgPSBfY2xhc3MudHlwZVBhcmFtZXRlcnM7XHJcbiAgaWYgKHR5cGVQYXJhbWV0ZXJzKSB7XHJcbiAgICBuYW1lICs9IGA8JHt0eXBlUGFyYW1ldGVycy5tYXAoZ2V0TmFtZSkuam9pbihcIiwgXCIpfT5gO1xyXG4gIH1cclxuICByZXR1cm4gbmFtZTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGlzTWV0aG9kTmFtZWQobmFtZTogc3RyaW5nKTogKF86IERlY2xhcmF0aW9uU3RhdGVtZW50KSA9PiBib29sZWFuIHtcclxuICByZXR1cm4gKHN0bXQ6IERlY2xhcmF0aW9uU3RhdGVtZW50KSA9PiBzdG10LmtpbmQgPT0gTm9kZUtpbmQuTWV0aG9kRGVjbGFyYXRpb24gJiYgdG9TdHJpbmcoc3RtdC5uYW1lKSA9PT0gbmFtZTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHVwZGF0ZVNvdXJjZShwcm9ncmFtOiBQcm9ncmFtLCBuZXdTb3VyY2U6IFNvdXJjZSkge1xyXG4gIGNvbnN0IHNvdXJjZXMgPSBwcm9ncmFtLnNvdXJjZXM7XHJcbiAgZm9yIChsZXQgaSA9IDAsIGxlbiA9IHNvdXJjZXMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHtcclxuICAgICAgaWYgKHNvdXJjZXNbaV0uaW50ZXJuYWxQYXRoID09IG5ld1NvdXJjZS5pbnRlcm5hbFBhdGgpIHtcclxuICAgICAgICAgIHNvdXJjZXNbaV0gPSBuZXdTb3VyY2U7XHJcbiAgICAgICAgICBicmVhaztcclxuICAgICAgfVxyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIFN0cmluZ0J1aWxkZXIge1xyXG4gIHByaXZhdGUgc2I6IHN0cmluZ1tdID0gW107XHJcblxyXG4gIHB1c2goczogc3RyaW5nKTogdm9pZCB7XHJcbiAgICB0aGlzLnNiLnB1c2gocyk7XHJcbiAgfVxyXG5cclxuICBmaW5pc2goc2VwYXJhdG9yID0gXCJcXG5cIik6IHN0cmluZyB7XHJcbiAgICBsZXQgcmVzID0gdGhpcy5zYi5qb2luKHNlcGFyYXRvcik7XHJcbiAgICB0aGlzLnNiID0gW107XHJcbiAgICByZXR1cm4gcmVzO1xyXG4gIH1cclxuXHJcbiAgZ2V0ICBsYXN0KCk6IHN0cmluZyB7IHJldHVybiB0aGlzLnNiW3RoaXMuc2IubGVuZ3RoIC0xXX1cclxufVxyXG5cclxuLyoqXHJcbiAqXHJcbiAqIEBwYXJhbSBlbWl0dGVyIERpYWdub3N0aWNFbWl0dGVyXHJcbiAqIEByZXR1cm5zIHJldHVybiB0cnVlIGlmIGVtaXR0ZXIgaGF2ZSBFUlJPUiBtZXNzYWdlXHJcbiAqL1xyXG4gZXhwb3J0IGZ1bmN0aW9uIGhhc0Vycm9yTWVzc2FnZShlbWl0dGVyOiBEaWFnbm9zdGljRW1pdHRlcik6IGJvb2xlYW4ge1xyXG4gIHJldHVybiBoYXNNZXNzYWdlKGVtaXR0ZXIsIERpYWdub3N0aWNDYXRlZ29yeS5FcnJvcik7XHJcbn1cclxuXHJcbi8qKlxyXG4qXHJcbiogQHBhcmFtIGVtaXR0ZXIgRGlhZ25vc3RpY0VtaXR0ZXJcclxuKiBAcmV0dXJucyByZXR1cm4gdHJ1ZSBpZiBlbWl0dGVyIGhhdmUgV0FSTklORyBtZXNzYWdlXHJcbiovXHJcbmV4cG9ydCBmdW5jdGlvbiBoYXNXYXJuaW5nTWVzc2FnZShlbWl0dGVyOiBEaWFnbm9zdGljRW1pdHRlcik6IGJvb2xlYW4ge1xyXG4gIHJldHVybiBoYXNNZXNzYWdlKGVtaXR0ZXIsIERpYWdub3N0aWNDYXRlZ29yeS5XYXJuaW5nKTtcclxufVxyXG5cclxuLyoqXHJcbipcclxuKiBAcGFyYW0gZW1pdHRlciBEaWFnbm9zdGljRW1pdHRlclxyXG4qIEByZXR1cm5zIHJldHVybiB0cnVlIGlmIGVtaXR0ZXIgaGF2ZSBgY2F0ZWdvcnlgIG1lc3NhZ2VcclxuKi9cclxuZXhwb3J0IGZ1bmN0aW9uIGhhc01lc3NhZ2UoXHJcbiAgZW1pdHRlcjogRGlhZ25vc3RpY0VtaXR0ZXIsXHJcbiAgY2F0ZWdvcnk6IERpYWdub3N0aWNDYXRlZ29yeVxyXG4pOiBib29sZWFuIHtcclxuICBjb25zdCBkaWFnbm9zdGljcyA9IGVtaXR0ZXIuZGlhZ25vc3RpY3MgPyBlbWl0dGVyLmRpYWdub3N0aWNzIDogW107XHJcbiAgZm9yIChjb25zdCBtc2cgb2YgZGlhZ25vc3RpY3MpIHtcclxuICAgICAgaWYgKG1zZy5jYXRlZ29yeSA9PT0gY2F0ZWdvcnkpIHtcclxuICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICB9XHJcbiAgfVxyXG4gIHJldHVybiBmYWxzZTtcclxufVxyXG5cclxuXHJcbmxldCBpc1N0ZGxpYlJlZ2V4ID1cclxuICAvXFx+bGliXFwvKD86YXJyYXl8YXJyYXlidWZmZXJ8YXRvbWljc3xidWlsdGluc3xjcnlwdG98Y29uc29sZXxjb21wYXR8ZGF0YXZpZXd8ZGF0ZXxkaWFnbm9zdGljc3xlcnJvcnxmdW5jdGlvbnxpdGVyYXRvcnxtYXB8bWF0aHxudW1iZXJ8b2JqZWN0fHByb2Nlc3N8cmVmZXJlbmNlfHJlZ2V4cHxzZXR8c3RhdGljYXJyYXl8c3RyaW5nfHN5bWJvbHx0YWJsZXx0eXBlZGFycmF5fHZlY3RvcnxydFxcLz98YmluZGluZ3NcXC98c2hhcmVkXFwvdHlwZWluZm8pfHV0aWxcXC98dXJpfHBvbHlmaWxsc3xtZW1vcnkvO1xyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGlzU3RkbGliKHM6IFNvdXJjZSB8IHsgcmFuZ2U6IFJhbmdlIH0pOiBib29sZWFuIHtcclxuICBsZXQgc291cmNlID0gcyBpbnN0YW5jZW9mIFNvdXJjZSA/IHMgOiBzLnJhbmdlLnNvdXJjZTtcclxuICByZXR1cm4gaXNTdGRsaWJSZWdleC50ZXN0KHNvdXJjZS5pbnRlcm5hbFBhdGgpO1xyXG59XHJcblxyXG5leHBvcnQgY29uc3QgaW5kZW50ID0gdXRpbC5pbmRlbnQ7XHJcbiJdfQ==