import { networks } from '@btc-vision/bitcoin';
import { BinaryWriter } from '../../buffer/BinaryWriter.js';
import { Generator } from '../Generator.js';
export class P2WDAGenerator extends Generator {
    constructor(senderPubKey, contractSaltPubKey, network = networks.bitcoin) {
        super(senderPubKey, contractSaltPubKey, network);
    }
    static validateWitnessSize(dataSize, maxWitnessFields = 10, maxBytesPerWitness = 80) {
        const signatureSize = 64;
        const compressionRatio = 0.7;
        const totalSize = dataSize + signatureSize;
        const compressedSize = Math.ceil(totalSize * compressionRatio);
        const requiredFields = Math.ceil(compressedSize / maxBytesPerWitness);
        return requiredFields <= maxWitnessFields;
    }
    compile(calldata, contractSecret, challenge, maxPriority, featuresRaw = []) {
        if (!this.contractSaltPubKey) {
            throw new Error('Contract salt public key not set');
        }
        if (contractSecret.length !== 32) {
            throw new Error('Contract secret must be exactly 32 bytes');
        }
        const writer = new BinaryWriter();
        writer.writeU8(P2WDAGenerator.P2WDA_VERSION);
        const features = featuresRaw.sort((a, b) => a.priority - b.priority);
        writer.writeBytes(this.getHeader(maxPriority, features.map((f) => f.opcode)));
        writer.writeBytes(contractSecret);
        writer.writeBytes(challenge.publicKey.toBuffer());
        writer.writeBytes(challenge.solution);
        writer.writeU32(calldata.length);
        writer.writeBytes(calldata);
        this.writeFeatures(writer, features);
        return Buffer.from(writer.getBuffer());
    }
    getHeader(maxPriority, features = []) {
        return super.getHeader(maxPriority, features);
    }
    writeFeatures(writer, features) {
        writer.writeU16(features.length);
        for (const feature of features) {
            writer.writeU8(feature.opcode);
            this.encodeFeature(feature, writer);
        }
    }
}
P2WDAGenerator.P2WDA_VERSION = 0x01;
